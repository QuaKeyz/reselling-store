<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin • Infernos</title>
  <link rel="stylesheet" href="/style.css" />
  <style>
    .admin-wrap { display:grid; grid-template-columns: 420px 1fr; gap: 16px; }
    @media (max-width: 980px){ .admin-wrap{ grid-template-columns: 1fr; } }
    input, textarea, select { width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--border); background:rgba(17,24,39,0.6); color:var(--text); outline:none; }
    textarea{ min-height: 90px; }
    table{ width:100%; border-collapse: collapse; }
    th,td{ text-align:left; border-bottom:1px solid var(--border); padding:10px 8px; font-size: 13px; vertical-align: top; }
    .small { font-size: 12px; color: var(--muted); }
    .pill { display:inline-block; padding:4px 8px; border:1px solid var(--border); border-radius:999px; background:rgba(0,0,0,0.18); margin-right:6px; }
    .row2 { display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
  </style>
</head>
<body>
<section style="margin-top:16px;">
  <div class="card" style="padding:14px;">
    <h2 style="margin:0 0 8px; letter-spacing:0.6px; text-transform:uppercase;">Bulk Import Inventory</h2>
    <p style="margin:0 0 10px; opacity:0.8;">
      Paste JSON array of products. Prices are <b>cents</b> (e.g. $65.00 = 6500).
    </p>

    <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-bottom:10px;">
      <label style="display:flex; gap:8px; align-items:center;">
        <input type="radio" name="importMode" value="create" checked />
        Create only (don’t overwrite)
      </label>
      <label style="display:flex; gap:8px; align-items:center;">
        <input type="radio" name="importMode" value="upsert" />
        Upsert (update if ID exists)
      </label>
      <button id="importBtn" class="btn primary" type="button">Import Now</button>
    </div>

    <textarea id="importJson" class="input" style="width:100%; min-height:220px; font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;"
      placeholder='[{"name":"Item","priceCents":6500,"inventory":1,"category":"Streetwear","brand":"...","condition":"New","size":"M","description":"...","imageUrl":"/uploads/xxx.jpg","active":true}]'></textarea>

    <pre id="importResult" style="margin:10px 0 0; white-space:pre-wrap; opacity:0.9;"></pre>
  </div>
</section>

  <div class="container">
    <div class="header">
      <div class="brand">
        <h1>Admin Dashboard</h1>
        <p>Manage products, upload photos, view orders.</p>
      </div>
      <div class="actions">
        <a class="btn" href="/">Back to store</a>
        <button class="btn danger" id="logoutBtn">Logout</button>
      </div>
    </div>

    <div class="card" id="loginCard" style="padding:18px; max-width:520px;">
      <h2 style="margin:0 0 10px 0;">Login</h2>
      <div class="small">Enter your ADMIN_PASSWORD (from .env)</div>
      <div style="height:10px;"></div>
      <input id="password" type="password" placeholder="Admin password" />
      <div style="height:10px;"></div>
      <button class="btn primary" id="loginBtn">Login</button>
      <div id="loginMsg" class="small" style="margin-top:10px;"></div>
    </div>

    <div id="app" style="display:none;">
      <div class="admin-wrap">
        <div class="card" style="padding:14px;">
          <h2 style="margin:0 0 10px 0;">Add / Edit Product</h2>

          <div class="small">Click a product on the right to edit it. Or fill and “Create”.</div>
          <div style="height:10px;"></div>

          <label class="small">ID (optional; auto-generated)</label>
          <input id="p_id" placeholder="airpods-pro-2" />

          <div style="height:10px;"></div>
          <label class="small">Name</label>
          <input id="p_name" placeholder="AirPods Pro (Used)" />

          <div style="height:10px;"></div>
          <div class="row2">
            <div>
              <label class="small">Price (cents)</label>
              <input id="p_price" type="number" min="50" step="1" placeholder="14000" />
              <div class="small">Example: $140.00 → 14000</div>
            </div>
            <div>
              <label class="small">Inventory</label>
              <input id="p_inventory" type="number" min="0" step="1" placeholder="1" />
            </div>
          </div>

          <div style="height:10px;"></div>
          <div class="row2">
            <div>
              <label class="small">Category</label>
              <select id="p_category">
                <option>Clothing</option>
                <option>Shoes</option>
                <option>Headphones</option>
                <option>Accessories</option>
                <option>General</option>
              </select>
            </div>
            <div>
              <label class="small">Condition</label>
              <select id="p_condition">
                <option>New</option>
                <option>Like New</option>
                <option selected>Good</option>
                <option>Fair</option>
              </select>
            </div>
          </div>

          <div style="height:10px;"></div>
          <div class="row2">
            <div>
              <label class="small">Brand</label>
              <input id="p_brand" placeholder="Nike / Apple / Designer…" />
            </div>
            <div>
              <label class="small">Size</label>
              <input id="p_size" placeholder="M / L / 10 / 9.5 …" />
            </div>
          </div>

          <div style="height:10px;"></div>
          <label class="small">Description</label>
          <textarea id="p_description" placeholder="Notes: box included, no scratches, etc."></textarea>

          <div style="height:10px;"></div>
          <label class="small">Image URL</label>
          <input id="p_imageUrl" placeholder="/uploads/yourphoto.jpg" />

          <div style="height:10px;"></div>
          <label class="small">Upload image</label>
          <input id="p_imageFile" type="file" accept="image/*" />

          <div style="height:10px;"></div>
          <label class="small">
            <input id="p_active" type="checkbox" checked />
            Active (shows in store)
          </label>

          <div style="height:12px;"></div>
          <div class="row" style="justify-content:flex-start; gap:10px;">
            <button class="btn primary" id="createBtn">Create</button>
            <button class="btn" id="updateBtn" disabled>Update</button>
            <button class="btn danger" id="deleteBtn" disabled>Delete</button>
            <button class="btn" id="clearBtn">Clear</button>
          </div>

          <div id="msg" class="small" style="margin-top:10px;"></div>
        </div>

        <div>
          <div class="card" style="padding:14px; margin-bottom:16px;">
            <h2 style="margin:0 0 10px 0;">Products</h2>
            <div class="small">Tip: set Inventory to 0 to “sold out”. Or uncheck Active to hide.</div>
            <div style="height:10px;"></div>
            <div id="productsList" class="small"></div>
          </div>

          <div class="card" style="padding:14px;">
            <h2 style="margin:0 0 10px 0;">Orders</h2>
            <div class="small">Paid orders auto-mark as paid when webhook is set.</div>
            <div style="height:10px;"></div>
            <div style="overflow:auto;">
              <table>
                <thead>
                  <tr>
                    <th>When</th>
                    <th>Status</th>
                    <th>Customer</th>
                    <th>Items</th>
                    <th>Subtotal</th>
                  </tr>
                </thead>
                <tbody id="ordersBody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <script src="/admin.js"></script>
<script>
  function getAdminToken() {
  return (
    window.adminToken ||
    localStorage.getItem("adminToken") ||
    sessionStorage.getItem("adminToken") ||
    localStorage.getItem("token") ||
    sessionStorage.getItem("token") ||
    localStorage.getItem("ADMIN_TOKEN") ||
    sessionStorage.getItem("ADMIN_TOKEN") ||
    ""
  );
}


  function pickMode() {
    const el = document.querySelector('input[name="importMode"]:checked');
    return el ? el.value : "create";
  }

  async function bulkImport() {
    const resultEl = document.getElementById("importResult");
    const btn = document.getElementById("importBtn");
    const token = getAdminToken();

    if (!token) {
      resultEl.textContent = "❌ You must log in first (admin token not found).";
      return;
    }

    let parsed;
    try {
      parsed = JSON.parse(document.getElementById("importJson").value);
    } catch (e) {
      resultEl.textContent = "❌ Invalid JSON: " + e.message;
      return;
    }

    if (!Array.isArray(parsed) || parsed.length === 0) {
      resultEl.textContent = "❌ JSON must be a non-empty array of products.";
      return;
    }

    btn.disabled = true;
    resultEl.textContent = "Importing...";

    try {
      const r = await fetch("/api/admin/bulk-import", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "Bearer " + token
        },
        body: JSON.stringify({ mode: pickMode(), products: parsed })
      });

      const data = await r.json().catch(() => ({}));
      if (!r.ok) {
        resultEl.textContent = "❌ Import failed: " + (data.error || r.statusText);
        return;
      }

      resultEl.textContent =
        "✅ Import complete\n" +
        "Created: " + data.createdCount + "\n" +
        "Updated: " + data.updatedCount + "\n" +
        "Errors: " + data.errorCount + "\n\n" +
        JSON.stringify(data.errors?.slice(0, 15) || [], null, 2);

      // If your admin page has a refresh/load function, call it:
      if (typeof window.loadProducts === "function") window.loadProducts();
      if (typeof window.refreshProducts === "function") window.refreshProducts();

    } catch (e) {
      resultEl.textContent = "❌ Import failed: " + e.message;
    } finally {
      btn.disabled = false;
    }
  }

  document.getElementById("importBtn")?.addEventListener("click", bulkImport);
</script>

</body>
</html>
